package keystrokesmod.module.impl.exploit.disabler;

import io.netty.buffer.Unpooled;
import keystrokesmod.event.*;
import keystrokesmod.module.ModuleManager;
import keystrokesmod.module.impl.exploit.Disabler;
import keystrokesmod.module.impl.exploit.disabler.hypixel.HypixelMotionDisabler;
import keystrokesmod.module.impl.world.Scaffold;
import keystrokesmod.module.setting.impl.ButtonSetting;
import keystrokesmod.module.setting.impl.LiteralSubMode;
import keystrokesmod.module.setting.impl.ModeValue;
import keystrokesmod.module.setting.impl.SubMode;
import keystrokesmod.utility.PacketUtils;
import net.minecraft.network.PacketBuffer;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;
import net.minecraftforge.fml.common.eventhandler.EventPriority;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import org.jetbrains.annotations.NotNull;

public class HypixelDisabler extends SubMode<Disabler> {
    public final ModeValue motion;
    private final ButtonSetting cancelSprint;
    private final ButtonSetting scaffold;

    public HypixelDisabler(String name, @NotNull Disabler parent) {
        super(name, parent);
        this.registerSetting(motion = new ModeValue("Motion Disabler", this)
                .add(new LiteralSubMode("Disabled", this))
                .add(new HypixelMotionDisabler("Enabled", this))
        );
        this.registerSetting(cancelSprint = new ButtonSetting("Cancel sprint", false));
        this.registerSetting(scaffold = new ButtonSetting("Scaffold Test", false));
    }

    @Override
    public void onEnable() {
        motion.enable();
    }

    @Override
    public void onDisable() {
        motion.disable();
    }

    @SubscribeEvent(priority = EventPriority.HIGHEST)
    public void onPreMotion(PreMotionEvent event) {
        if (cancelSprint.isToggled())
            event.setSprinting(false);
        if (scaffold.isToggled() && ModuleManager.scaffold.isEnabled()) {
            if (Scaffold.sprint() && Math.random() > 0.6) {
                PacketUtils.sendPacket(new C0APacketAnimation());
                PacketUtils.sendPacket(new C17PacketCustomPayload("Remove Watchdog", new PacketBuffer(Unpooled.EMPTY_BUFFER)));
            }
        }
    }

    @SubscribeEvent(priority = EventPriority.LOWEST)
    public void onReceivePacket(@NotNull ReceivePacketEvent event) {
        if (event.getPacket() instanceof S08PacketPlayerPosLook) {
            if (mc.thePlayer.isUsingItem()) {
                if (mc.thePlayer.isBlocking()) {
                    PacketUtils.sendPacket(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.RELEASE_USE_ITEM, BlockPos.ORIGIN, EnumFacing.UP));
                } else {
                    mc.playerController.onStoppedUsingItem(mc.thePlayer);
                }
            }
        }
    }
}
