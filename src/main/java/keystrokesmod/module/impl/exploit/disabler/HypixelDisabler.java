package keystrokesmod.module.impl.exploit.disabler;

import keystrokesmod.event.*;
import keystrokesmod.mixins.impl.network.C0FPacketConfirmTransactionAccessor;
import keystrokesmod.module.impl.exploit.Disabler;
import keystrokesmod.module.impl.exploit.disabler.hypixel.HypixelMotionDisabler;
import keystrokesmod.module.setting.impl.ButtonSetting;
import keystrokesmod.module.setting.impl.LiteralSubMode;
import keystrokesmod.module.setting.impl.ModeValue;
import keystrokesmod.module.setting.impl.SubMode;
import keystrokesmod.utility.PacketUtils;
import net.minecraft.client.gui.inventory.GuiContainer;
import net.minecraft.client.gui.inventory.GuiInventory;
import net.minecraft.network.play.client.*;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;
import net.minecraftforge.fml.common.eventhandler.EventPriority;
import net.minecraftforge.fml.common.eventhandler.SubscribeEvent;
import org.jetbrains.annotations.NotNull;

public class HypixelDisabler extends SubMode<Disabler> {
    public final ModeValue motion;
    private final ButtonSetting inventory;
    private final ButtonSetting cancelSprint;

    private boolean inventoryDisabling = false;

    public HypixelDisabler(String name, @NotNull Disabler parent) {
        super(name, parent);
        this.registerSetting(motion = new ModeValue("Motion Disabler", this)
                .add(new LiteralSubMode("Disabled", this))
                .add(new HypixelMotionDisabler("Enabled", this))
        );
        this.registerSetting(inventory = new ButtonSetting("Inventory", false));
        this.registerSetting(cancelSprint = new ButtonSetting("Cancel sprint", false));
    }

    @Override
    public void onEnable() {
        motion.enable();
    }

    @Override
    public void onDisable() {
        motion.disable();
    }

    @SubscribeEvent(priority = EventPriority.HIGHEST)
    public void onPreMotion(PreMotionEvent event) {
        if (cancelSprint.isToggled())
            event.setSprinting(false);
    }

    @SubscribeEvent(priority = EventPriority.LOWEST)
    public void onReceivePacket(@NotNull ReceivePacketEvent event) {
        if (event.getPacket() instanceof S08PacketPlayerPosLook) {
            if (mc.thePlayer.isUsingItem()) {
                if (mc.thePlayer.isBlocking()) {
                    PacketUtils.sendPacket(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.RELEASE_USE_ITEM, BlockPos.ORIGIN, EnumFacing.UP));
                } else {
                    mc.playerController.onStoppedUsingItem(mc.thePlayer);
                }
            }
        }
    }

    @SubscribeEvent(priority = EventPriority.LOWEST)
    public void onSendPacket(@NotNull SendPacketEvent event) {
        if (event.getPacket() instanceof C0EPacketClickWindow && inventory.isToggled() && !inventoryDisabling) {
            if (((C0EPacketClickWindow) event.getPacket()).getWindowId() == mc.thePlayer.inventoryContainer.windowId 
                    && !(mc.currentScreen instanceof GuiInventory)) {
                event.setCanceled(true);
                inventoryDisabling = true;
                PacketUtils.sendPacket(new C16PacketClientStatus(C16PacketClientStatus.EnumState.OPEN_INVENTORY_ACHIEVEMENT));
                PacketUtils.sendPacket(event.getPacket());
                PacketUtils.sendPacket(new C0DPacketCloseWindow(mc.thePlayer.inventoryContainer.windowId));
                inventoryDisabling = false;
            }
        }
    }
}
